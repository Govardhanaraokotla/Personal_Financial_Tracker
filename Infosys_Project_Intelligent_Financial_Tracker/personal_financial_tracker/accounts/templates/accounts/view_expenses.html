<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Expenses</title>
    <style>
        /* General styles for layout */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        h1 {
            text-align: center;
            color: #333;
            margin: 20px 0;
        }

        /* Table Styles */
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, #007bff, #00aaff);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        td {
            background: #ffffff;
        }

        td:first-child, td:nth-child(2), td:nth-child(3) {
            font-size: 16px;
            color: #444;
        }

        /* Action buttons */
        .action-buttons button {
            padding: 6px 12px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .update-button {
            background-color: #4CAF50;
            color: white;
        }

        .update-button:hover {
            background-color: #45a049;
        }

        .delete-button {
            background-color: #f44336;
            color: white;
        }

        .delete-button:hover {
            background-color: #d32f2f;
        }

        .action-buttons button:focus {
            outline: none;
        }

        /* Success and Failure message */
        .alert-success, .alert-danger {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            width: 80%;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }

        .alert-success {
            background-color: #4CAF50;
        }

        .alert-danger {
            background-color: #f44336;
        }

        /* Download Button */
        .download-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 30px;
        }

        .download-btn:hover {
            background-color: #0056b3;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            table {
                width: 95%;
            }

            .download-btn {
                width: 100%;
                margin-top: 20px;
            }

            td, th {
                padding: 8px;
            }

            .action-buttons button {
                padding: 4px 8px;
                font-size: 14px;
            }
        }

        /* Hover and animation effects */
        table tr:hover {
            background-color: #f1f1f1;
            transform: scale(1.02);
            transition: background-color 0.3s, transform 0.3s;
        }

        /* Transition effect for deleting rows */
        .fade-out {
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0;
            transform: translateX(-100%);
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 10000;
        }

        .confirmation-dialog button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .confirmation-dialog .confirm-btn {
            background-color: #f44336;
            color: white;
        }

        .confirmation-dialog .confirm-btn:hover {
            background-color: #d32f2f;
        }

        .confirmation-dialog .cancel-btn {
            background-color: #007bff;
            color: white;
        }

        .confirmation-dialog .cancel-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Your Expenses</h1>

    <!-- Displaying messages -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                {% if message.tags == "success" %}
                    <div class="alert-success">{{ message }}</div>
                {% else %}
                    <div class="alert-danger">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <table id="expenses-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Amount (INR)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
                <tr id="expense-row-{{ expense.id }}" data-expense-id="{{ expense.id }}">
                    <td>{{ expense.date }}</td>
                    <td>{{ expense.description }}</td>
                    <td>{{ expense.amount }}</td>
                    <td class="action-buttons">
                        <a href="{% url 'edit_expense' expense.id %}">
                            <button class="update-button" title="Update Expense">Update</button>
                        </a>
                        <button class="delete-button delete-expense-btn" title="Delete Expense">Delete</button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; font-size: 18px; color: #666;">No expenses found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- CSRF Token
    <input type="hidden" id="csrf-token" value="{% csrf_token %}"> -->

    <!-- Download Button -->
    <button class="download-btn" id="download-pdf">Download PDF</button>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmation-dialog">
        <p>Are you sure you want to delete this expense?</p>
        <button class="confirm-btn" id="confirm-delete">Yes</button>
        <button class="cancel-btn" id="cancel-delete">No</button>
    </div>

    <!-- Include jsPDF Library and AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const csrfToken = document.getElementById('csrf-token').value;
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmDeleteButton = document.getElementById('confirm-delete');
            const cancelDeleteButton = document.getElementById('cancel-delete');

            // Display message fade-in and fade-out effect
            const alertMessages = document.querySelectorAll('.alert');
            alertMessages.forEach(alert => {
                alert.style.opacity = 1;
                setTimeout(() => {
                    alert.style.opacity = 0;
                }, 3000); // Hide after 3 seconds
            });

            // Delete expense confirmation
            const deleteButtons = document.querySelectorAll('.delete-expense-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const expenseId = e.target.closest('tr').getAttribute('data-expense-id');
                    confirmationDialog.style.display = 'block';

                    confirmDeleteButton.onclick = () => {
                        fetch(`/delete_expense/${expenseId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const row = document.getElementById('expense-row-' + expenseId);
                                row.classList.add('fade-out');
                                setTimeout(() => {
                                    row.remove();
                                    confirmationDialog.style.display = 'none';
                                }, 500);
                            } else {
                                alert('Error deleting expense');
                            }
                        });
                    };

                    cancelDeleteButton.onclick = () => {
                        confirmationDialog.style.display = 'none';
                    };
                });
            });

            // Download expenses as PDF
            document.getElementById('download-pdf').addEventListener('click', () => {
                const doc = new jsPDF();
                const table = document.getElementById('expenses-table');
                doc.autoTable({ html: table });
                doc.save('expenses.pdf');
            });
        });
    </script>
</body>
</html>
